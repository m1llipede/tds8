# TDS-8 v0.31 Fixes - October 14, 2025

## 🐛 Issues Fixed

### 1. **Header Comment Updated**
**Problem:** File header still said "v30" even though code was v0.31  
**Fix:** Updated header comment to reflect v31 with new features listed

**Changed:**
```cpp
// OLD:
TDS-8 (Track Display Strip - 8 channels)  — v30 WIRED-FIRST

// NEW:
TDS-8 (Track Display Strip - 8 channels)  — v31 OFFSET SUPPORT
```

---

### 2. **Blank Displays on Startup**
**Problem:** OLEDs showed "Track 1", "Track 2", etc. on startup  
**Fix:** Changed default track names to empty strings

**Changed:**
```cpp
// OLD:
String trackNames[numScreens] = {
  "Track 1","Track 2","Track 3","Track 4",
  "Track 5","Track 6","Track 7","Track 8"
};

// NEW:
String trackNames[numScreens] = {"", "", "", "", "", "", "", ""}; // Start blank
```

**Result:** OLEDs now show:
- Center: Blank (until track name is sent)
- Bottom: Track number (1, 2, 3, etc.)

---

### 3. **Bridge Refresh Button Error**
**Problem:** Clicking refresh button gave error: "Failed to send refresh request"  
**Error:** `osc.OSCMessage` constructor was incorrect

**Fix:** Updated `/api/osc-send` endpoint to use correct OSC message format

**Changed:**
```javascript
// OLD:
const message = new osc.OSCMessage(address);
if (args && Array.isArray(args)) {
  args.forEach(arg => message.add(arg));
}
port.send(message, "127.0.0.1", 9000);

// NEW:
const oscMsg = {
  address: address,
  args: args && Array.isArray(args) ? args.map(arg => ({
    type: typeof arg === 'number' ? (Number.isInteger(arg) ? 'i' : 'f') : 's',
    value: arg
  })) : []
};
port.send(oscMsg, "127.0.0.1", 9000);
```

**Result:** Refresh button now works correctly

---

## 📋 Current Display Behavior

### **On Startup (No Track Names Sent):**
```
┌──────────────┐
│              │
│              │  ← Empty (no text)
│              │
│      1       │  ← Track number (small, bottom)
└──────────────┘
```

### **After Track Name Sent:**
```
┌──────────────┐
│              │
│    Kick      │  ← Track name (large, centered)
│              │
│      9       │  ← Actual track number (small, bottom)
└──────────────┘
```

### **Text Handling:**
- ✅ Automatically shrinks to fit (size 2 → size 1)
- ✅ Splits into two lines if needed
- ✅ Truncates with "..." if still too long
- ✅ Track number never overlaps with name (always at bottom)

---

## 🧪 Testing Checklist

### Test 1: Upload Firmware
- [ ] Upload OLED30.ino to XIAO
- [ ] Open Serial Monitor (115200 baud)
- [ ] Type: `VERSION`
- [ ] Should see: `VERSION: 0.31`

### Test 2: Blank Displays
- [ ] After upload, all OLEDs should be blank except for small numbers at bottom
- [ ] Should show: 1, 2, 3, 4, 5, 6, 7, 8

### Test 3: Bridge Refresh Button
- [ ] Restart Bridge: `node index.js`
- [ ] Open: http://localhost:8088
- [ ] Click offset buttons (◀ ▶)
- [ ] Click "🔄 Refresh from Ableton"
- [ ] Should see in console: `📡 OSC sent to M4L: /refresh [0]`
- [ ] No errors

### Test 4: Track Names Display
- [ ] Send test command: `/trackname 0 "Test Track" 8`
- [ ] OLED 0 should show:
  - Center: "Test Track"
  - Bottom: "9"

### Test 5: Long Track Names
- [ ] Send: `/trackname 0 "Very Long Track Name That Should Wrap" 0`
- [ ] Should wrap to two lines or truncate
- [ ] Track number "1" should still be visible at bottom

---

## 🔄 What Changed in Each File

### `/Users/test/Music/TDS-8/OLED30/OLED30.ino`
- Lines 1-23: Updated header comment
- Line 59: Changed default track names to empty strings
- Version: 0.31
- Build: 2025.10.13-offset

### `/Users/test/Music/TDS-8/tds8-bridge/index.js`
- Lines 339-365: Fixed `/api/osc-send` endpoint
- Changed OSC message construction to use correct format
- Added proper error response with `ok: false`

---

## 🚀 Next Steps

1. **Upload v0.31 firmware** to your XIAO
2. **Restart Bridge** to get the OSC fix
3. **Test refresh button** - should work now
4. **Build M4L patch** to complete the system
5. **Test full workflow** with offset changes

---

## 📝 Summary

**Fixed:**
- ✅ Header comment now says v31
- ✅ Displays start blank (no "Track 1" text)
- ✅ Track numbers show at bottom (1, 2, 3, etc.)
- ✅ Refresh button works (OSC send fixed)
- ✅ Text never overlaps (smart layout)

**Ready to test:**
- Upload firmware
- Restart bridge
- Test refresh button
- Build M4L patch

---

**Date:** October 14, 2025  
**Version:** 0.31  
**Status:** ✅ Ready for testing
