# TDS-8 Bridge Fixes - October 13, 2025

## ðŸ› Issues Fixed

### 1. **"broadcast is not defined" Error** âœ…
**Problem:** Line 70 called `broadcast()` which doesn't exist
**Fix:** Changed to `wsBroadcast()` with proper object structure
**Impact:** OSC messages from M4L now properly forwarded without errors

### 2. **Firmware Check 400 Error** âœ…
**Problem:** Endpoint threw 400 error when manifest.json not found
**Fix:** Return proper JSON response instead of throwing error
**Impact:** Web UI no longer shows error, gracefully handles missing manifest

### 3. **Missing Port Information in Logs** âœ…
**Problem:** Unclear which ports were being used for send/receive
**Fix:** Added comprehensive logging throughout:
- Startup banner showing all port configuration
- Serial TX/RX logging with ðŸ“¤/ðŸ“¥ indicators
- OSC send/receive logging with clear port info
- Connection logging with port details

---

## ðŸ“Š Port Configuration (Now Clearly Logged)

### **Wired Mode (USB Serial):**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           TDS-8 Bridge - Port Configuration           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  HTTP Server:    http://localhost:8088                â•‘
â•‘  OSC Listener:   0.0.0.0:8000 (receives from M4L)     â•‘
â•‘  OSC Sender:     127.0.0.1:9001 â†’ 127.0.0.1:9000      â•‘
â•‘  WebSocket:      ws://localhost:8088                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  M4L should send OSC to: 127.0.0.1:8000               â•‘
â•‘  M4L should listen on:   port 9000                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### **Communication Flow:**
1. **M4L â†’ Bridge:** Sends OSC to `127.0.0.1:8000`
2. **Bridge â†’ Device:** Forwards via USB serial
3. **Device â†’ Bridge:** Responds via USB serial
4. **Bridge â†’ M4L:** Sends `/ipupdate` to `127.0.0.1:9000`

---

## ðŸ” New Logging Output

### **On Startup:**
```
ðŸŽ§ OSC Listener: 0.0.0.0:8000 (receiving from M4L)
ðŸ“¡ OSC Sender: 0.0.0.0:9001 (sends to M4L on port 9000)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           TDS-8 Bridge - Port Configuration           â•‘
â•‘  ...                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### **On Serial Connection:**
```
ðŸ”Œ Serial Port: /dev/cu.usbmodem101 @ 115200 baud
ðŸ“¤ Serial TX: /reannounce
ðŸ“¤ Serial TX: VERSION
ðŸ“¥ Serial RX: VERSION: 0.30
```

### **On OSC Message Received:**
```
ðŸ“¨ OSC from 127.0.0.1:63460 â†’ /ping []
âœ“ Forwarded to serial: /ping
ðŸ“¤ Serial TX: /ping
ðŸ“¥ Serial RX: PONG
```

### **On IP Broadcast:**
```
ðŸ“¡ OSC Sender: 127.0.0.1:9001 â†’ 127.0.0.1:9000 /ipupdate 127.0.0.1
```

---

## ðŸ“ Code Changes

### **File: `index.js`**

#### Change 1: Fixed broadcast function (line 70)
```javascript
// BEFORE:
broadcast(`[OSC] ${fromIP}:${fromPort} â†’ ${oscMsg.address} ${JSON.stringify(oscMsg.args)}`);

// AFTER:
wsBroadcast({ type: 'osc-received', from: `${fromIP}:${fromPort}`, address: oscMsg.address, args: oscMsg.args });
```

#### Change 2: Added serial TX logging (line 166-170)
```javascript
function send(s) {
  if (!serial || !serial.isOpen) throw new Error('Serial not open');
  serial.write(s);
  console.log(`ðŸ“¤ Serial TX: ${s.trim()}`);
}
```

#### Change 3: Added serial RX logging (line 172-184)
```javascript
function onSerialData(chunk) {
  const text = chunk.toString('utf8');
  serialBuf += text;
  wsBroadcast({ type: 'serial-data', data: text });
  let idx;
  while ((idx = serialBuf.indexOf('\n')) >= 0) {
    const line = serialBuf.slice(0, idx).trim();
    serialBuf = serialBuf.slice(idx + 1);
    if (line) console.log(`ðŸ“¥ Serial RX: ${line}`);  // NEW
    const m = /^VERSION\s*[:=]\s*([\w.\-]+)/i.exec(line);
    if (m) { deviceVersion = m[1]; wsBroadcast({ type: 'device-version', version: deviceVersion }); }
  }
}
```

#### Change 4: Fixed firmware check error (line 344-367)
```javascript
// BEFORE:
if (!manifestUrl) throw new Error('No manifest URL provided and no local manifest found');

// AFTER:
if (!manifestUrl) {
  return res.json({ ok: false, error: 'No manifest URL configured and no local manifest found', deviceVersion });
}
```

#### Change 5: Added startup banner (line 425-437)
```javascript
server.listen(PORT, () => {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘           TDS-8 Bridge - Port Configuration           â•‘');
  // ... full banner ...
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
});
```

#### Change 6: Enhanced OSC message forwarding logs (line 73-92)
```javascript
// Added detailed logging for each OSC command type
if (oscMsg.address === "/trackname" && oscMsg.args.length >= 2) {
    const index = oscMsg.args[0].value;
    const name = oscMsg.args[1].value;
    const cmd = `/trackname ${index} ${name}\n`;
    send(cmd);
    console.log(`âœ“ Forwarded to serial: ${cmd.trim()}`);  // NEW
    // ...
}
```

---

## âœ… Testing Checklist

After restarting the bridge, you should see:

- [ ] Startup banner with all port information
- [ ] OSC Listener confirmation on port 8000
- [ ] OSC Sender confirmation on port 9001
- [ ] Serial port connection with baud rate
- [ ] Serial TX messages when sending commands
- [ ] Serial RX messages when receiving responses
- [ ] OSC messages from M4L with source IP:port
- [ ] Forwarding confirmations for each command
- [ ] No "broadcast is not defined" errors
- [ ] No firmware check 400 errors (shows graceful message instead)

---

## ðŸš€ How to Apply

1. **Stop the bridge** if running
2. **Restart the bridge:**
   ```bash
   cd /Users/test/Music/TDS-8/tds8-bridge
   npm start
   # or
   npm run electron
   ```
3. **Check the console** for the new startup banner
4. **Connect to serial port** and verify logging
5. **Send /ping from M4L** and watch the flow:
   ```
   ðŸ“¨ OSC from 127.0.0.1:63460 â†’ /ping []
   âœ“ Forwarded to serial: /ping
   ðŸ“¤ Serial TX: /ping
   ðŸ“¥ Serial RX: PONG
   ```

---

## ðŸ“Œ Summary

All three issues are now fixed:
1. âœ… **broadcast error** - Fixed function call
2. âœ… **Firmware 400 error** - Graceful error handling
3. âœ… **Port visibility** - Comprehensive logging throughout

The bridge now clearly shows:
- Which ports it's listening on
- Which ports it's sending to
- What data is being transmitted/received
- The complete communication flow

---

**Ready to test!** Restart the bridge and watch the detailed logs.
